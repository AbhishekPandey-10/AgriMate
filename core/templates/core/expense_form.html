{% extends 'core/base.html' %}
{% load i18n %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-8">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-red-50 to-orange-50 border-b border-gray-100 px-6 py-4">
            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <i data-lucide="receipt" class="h-6 w-6 text-red-600"></i>
                {% trans "Log Expense" %}
            </h2>
        </div>

        <div class="p-6">
            <form method="post" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                {{ form.as_p }}

                <div class="flex gap-3 mt-6">
                    <button type="submit"
                        class="flex-1 inline-flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="save" class="h-4 w-4"></i> {% trans "Save Expense" %}
                    </button>
                    <a href="{% url 'dashboard' %}"
                        class="inline-flex items-center justify-center gap-2 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        {% trans "Cancel" %}
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const form = document.querySelector('form');

    form.addEventListener('submit', function (e) {
        if (!navigator.onLine) {
            e.preventDefault();

            const formData = new FormData(form);
            const expenseData = {};
            formData.forEach((value, key) => {
                if (key !== 'csrfmiddlewaretoken') {
                    expenseData[key] = value;
                }
            });

            expenseData['temp_id'] = Date.now();

            let outbox = JSON.parse(localStorage.getItem('expense_outbox') || '[]');
            outbox.push(expenseData);
            localStorage.setItem('expense_outbox', JSON.stringify(outbox));

            alert('⚠️ You are OFFLINE. \n\nExpense saved to your device. It will sync automatically when you visit the Dashboard online.');

            window.location.href = "{% url 'dashboard' %}";
        }
    });
</script>
{% endblock %}